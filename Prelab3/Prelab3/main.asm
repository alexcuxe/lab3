;ISR_PCINT

.INCLUDE "M328PDEF.INC"
.CSEG
.ORG 0X00
	JMP SETUP		;RESET VECTOR

.ORG 0X000A
	JMP ISR_PCINT2	;ISR: PCINT0 VECTOR, FOR PORTD

SETUP:
	;STACK
	LDI R16, LOW(RAMEND)
	OUT SPL, R16
	LDI R17, HIGH(RAMEND)
	OUT SPH, R17

	SBI DDRB, PB5		;PB5 AS OUTPUT

	LDI R16, 0X0C		;PD2 AND PD3 AS INPUT WITH PULL-UP
	OUT PORTD, R16

	LDI R16, 0X00		;ENTIRE PORTD AS INTPUT
	OUT DDRD, R16

	LDI R16, 0X3F		;PC0-PC5 AS OUPUT
	OUT DDRC, R16

	LDI R16, (1 << PCINT19) | (1 << PCINT18)	;PCINT18/19 ENABLE
	STS PCMSK2, R16

	LDI R16, (1 << PCIE2)
	STS PCICR, R16			;CHANGING STATE INTERRUPTION ENABLE FOR PORTB
	
	SEI
	LDI R20, 0X00 

LOOP:
	OUT PORTC, R20		;SHOW COUNT   0b0000_0100
	RJMP LOOP

ISR_PCINT2:
	PUSH R16			;SAVE VALUES
	IN R16, SREG
	PUSH R16

	IN R18, PIND

	SBRC R18, PD2		;IF PB0 = 0, IT JUMPS NEXT TO THE INSTR
	JMP CHECKPD3
	INC R20
	CPI R20, 16
	BRNE EXIT
	LDI R20, 15
	JMP EXIT

CHECKPD3:
	SBRC R18, PD3
	JMP EXIT
	DEC R20
	CPI R20, 0XFF
	BRNE EXIT
	LDI R20, 0

EXIT:
	SBI PCIFR, PCIF2	;TURN OFF THE ISR PCINT2 FLAG, FOR PORTC

	POP R16				;RESTORE VALUES
	OUT SREG, R16
	POP R16
	RETI