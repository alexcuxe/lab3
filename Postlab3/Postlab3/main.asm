;UNIVERSIDAD DEL VALLE DE GUATEMALA
;IE2023: PROGRAMACIÓN DE MICROCONTROLADORES
;Laboratorio1.asm
;AUTOR: Eber Alexander Cuxé Tan
;PROYECTO: 2 DISPLAYS, MUX
;HARDWARE: ATMEGA328P
;CREADO: 30/01/2024
;ÚLTIMA MODIFICACIÓN: 30/01/2024 17:19

;ISR_TIMER0

.INCLUDE "M328PDEF.INC"
.CSEG
.ORG 0X00
	JMP SETUP		;RESET VECTOR
.ORG 0X0020
	JMP ISR_TIMER0	;ISR: TIMER0 VECTOR


MAIN:

	LDI R16, LOW(RAMEND)
	OUT SPL, R16
	LDI R17, HIGH(RAMEND)
	OUT SPH, R17

	SEG: .DB 0x3F,0x06,0x5B,0x4F,0x66,0x6D,0x7D,0x07,0x7F,0x6F,0x77,0x7C,0x39,0x5E,0x79,0x71

SETUP:
	LDI R16, 0X3F		;THE ENTIRE PORTB AS OUTPUT
	OUT DDRB, R16

	SBI PORTD, PD2
	SBI PORTD, PD3		;PD2 AND PD3 AS INPUT W PULL-UP

	CBI DDRD, PD2
	CBI DDRD, PD3
	SBI DDRD, PD7
	SBI DDRD, PD6
	SBI DDRD, PD5

	LDI R21, 0
	LDI ZH, HIGH(SEG << 1)
	LDI ZL, LOW(SEG << 1)
	ADD ZL, R21
	LPM R21, Z
	
	CALL INIT_T0
	SEI					;ENABLE GLOBAL INTERRUPTIONS

	LDI R20, 0			;COUNTER FOR TIMER
	LDI R21, 0			;COUNTER FOR DISPLAY
	LDI R23, 0

LOOP:
	CBI PORTD, PD5
	CBI PORTD, PD7
	CLR R22
	OUT PORTB, R22
	CBI PORTD, PD5
	CBI PORTD, PD7
	CALL DISPLAY1
	SBI PORTD, PD6		;DISPLAY 1
	CBI PORTD, PD5
	OUT PORTB, R22
	SBRC R22, 6
	SBI PORTD, PD7
	SBRS R22, 6
	CBI PORTD, PD7

	CBI PORTD, PD6
	CBI PORTD, PD7
	CLR R24
	OUT PORTB, R24
	CBI PORTD, PD6
	CBI PORTD, PD7
	CALL DISPLAY2
	SBI PORTD, PD5		;DISPLAY2
	CBI PORTD, PD6		;MUX
	OUT PORTB, R24		;IT SHOWS
	SBRC R24, 6			;UPLOAD SEG G
	SBI PORTD, PD7
	SBRS R24, 6
	CBI PORTD, PD7

	CPI R20, 100			; 100 * 10ms = 1000ms
	BRNE LOOP
	CLR R20				;IT CLEARS R20

	INC R21
	CPI R21, 10
	BREQ ZERO

	JMP LOOP

ZERO:
	LDI R21, 0
	INC R23
	CPI R23, 6
	BREQ SIX
	RJMP LOOP

SIX:
	LDI R23, 0
	RJMP LOOP

DISPLAY1:
	CLR R22
	CBI PORTD, PD7
	MOV R22, R21
	LDI ZH, HIGH(SEG << 1)
	LDI ZL, LOW(SEG << 1)
	ADD ZL, R22
	LPM R22, Z
	RET

DISPLAY2:
	CLR R24
	CBI PORTD, PD7
	MOV R24, R23
	LDI ZH, HIGH(SEG << 1)
	LDI ZL, LOW(SEG << 1)
	ADD ZL, R24
	LPM R24, Z
	RET

INIT_T0:
	LDI R16, (1 << CS02) | (1 << CS00)
	OUT TCCR0B, R16			;SET PRESCALER, 1024

	LDI R16, 99			;OVERFLOW VALUE, EVERY 10ms
	OUT TCNT0, R16		;LOAD START VALUE OF TIMER

	LDI R16, (1 << TOIE0)
	STS TIMSK0, R16			;INTERRUPTION ENABLE
	RET

ISR_TIMER0:
	LDI R16, 99			;VALUE OF TIMER OVERFLOW
	OUT TCNT0, R16		;LOAD THE OVERFLOW VALUE
	SBI TIFR0, TOV0		;TURN OFF FLAG
	INC R20				;INCREASE COUNTER OF 10ms
	RETI